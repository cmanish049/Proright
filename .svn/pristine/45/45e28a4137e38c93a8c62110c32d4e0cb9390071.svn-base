<?php

/**
 * Yazar      : Serkan Dağlıoğlu
 * E-posta    : serkandaglioglu@gmail.com
 * Web adresi : http://www.serkandaglioglu.com
 * 
 * Dökümantasyon adresi : http://www.serkandaglioglu.com/codeigniter-my_model-sinifi
 * Son güncelleme : 24 Kasım 2011
 */
class MY_Model extends CI_Model
{
    public $table = '';
    public $auto_increment = '';
    public $table_columns = array();
    public $select = array();
    public $where_rules = array();
    public $as = 'X';

    public function __construct($table = '', $auto_increment = '')
    {
        parent::__construct();

        if(!$table)
        {
            return;
        }

        $this->load->config('db_tables');

        $this->set_table($table);
        $this->set_auto_increment($auto_increment);
        $this->set_table_columns();
    }

    private function _reset_variables()
    {
        $this->select = array();
    }

    private function _has_one_column(&$object)
    {
        if(!is_object($object) && empty($object))
        {
            return FALSE;
        }
        
        $count = 0;
        foreach($object as $e)
        {
            if($count>1)
            {
                break;
            }
            $count++;
        }
        
        return $count==1;
    }
    
    public function call_before_extra_select()
    {
        
    }

    /**
     * id ile tek satırlık kayıt çeker
     */
    public function get_row_by_id($id, $extra = array())
    {
        $this->_extra($extra);
        $this->_extra_select($extra);
        $this->_extra_where($extra);
        $this->order_by($extra);
        $this->call_before_extra_select($extra);

        $object = $this->db->where($this->as . '.' . $this->auto_increment, $this->clean_id($id))
                ->limit(1)
                ->get("$this->table $this->as");

        $row = $object->row();
        $object->free_result();
        unset($object);

        $row = object_change_key_case($row);
        
        #Eğer bir tek alan istenmişse o alanın değerini dönderiyoruz
        if($this->_has_one_column($row))
        {
            $data = '';
            foreach($row as $e)
            {
                $data = $e;
                break;
            } 
            $row = $data;
        }

        $this->_reset_variables();
        return $row;
    }

    /**
     * örneğin WHERE -yazi_seo='yazi-seo-deger' şeklinde sorgu 
     * sonucunda tek satırlık kayıt çeker
     * 
     * @param type $where
     * @return type 
     */
    public function get_row_where($extra = array())
    {
        $this->_extra($extra);
        $this->_extra_select($extra);
        $this->_extra_where($extra);
        $this->order_by($extra);
        $this->call_before_extra_select($extra);

        $object = $this->db->limit(1)->get("$this->table $this->as");

        $row = $object->row();
        $object->free_result();
        unset($object);

        $row = object_change_key_case($row);
        
        #Eğer bir tek alan istenmişse o alanın değerini dönderiyoruz
        if($this->_has_one_column($row))
        {
            $data = '';
            foreach($row as $e)
            {
                $data = $e;
                break;
            } 
            $row = $data;
        }

        $this->_reset_variables();
        return $row;
    }

    /**
     * Birden fazla kayıt çeker
     * 
     * @param type $extra 
     */
    public function get_rows($extra = array())
    {
        $this->_extra($extra);
        $this->_extra_select($extra);
        $this->_extra_where($extra);
        $this->order_by($extra);
        $this->call_before_extra_select($extra);

        $object = $this->db->get("$this->table $this->as");

        $rows = $object->result();
        $object->free_result();
        unset($object);

        $rows = object_change_key_case($rows);
        /**
         * Eğer tek alan istenmişse tek boyutlu dizi haline getiriyoruz
         * 
         * Örneğin sonuc array([0]=>array('baslik'=>'başlık 1'),[1]=>array('baslik'=>'başlık 2')) dönmesi gerekiyorken
         * biz array('başlık 1','başlık 2') döndereceğiz
         */
        $object = (isset($rows[0]))?$rows[0]:NULL;
        if($this->_has_one_column($object))
        {
            $data = array();
            foreach($rows as $row)
            {
                foreach($row as $e)
                {
                    $data[] = $e;
                    break;
                }                    
            }
            $rows = $data;
        }

        $this->_reset_variables();
        return $rows;
    }

    /**
     * Veritabanındaki kayıt sayısını çeker.
     * 
     * @param type $where 
     */
    public function get_count($extra = array())
    {
        $this->_extra($extra);
        $this->_extra_where($extra);

        $object = $this->db->select('COUNT(*) AS adet')->get("$this->table $this->as");
        $adet = $object->row()->adet;

        $object->free_result();
        unset($object);

        $this->_reset_variables();
        return $adet;
    }

    /**
     * Codeigniterin form_helper fonksiyonu olan form_dropdown() fonksiyonuna gönderilecek
     * kayıtları çeker
     * 
     * @param type $value_column
     * @param type $text_column
     * @param type $extra 
     */
    public function dropdown($value_column = '', $text_column = '', $extra = array(), $first_value = '', $first_text = 'Seçiniz')
    {
        if(!$value_column) $value_column = $this->auto_increment;
        if(!$text_column) $text_column = $value_column;

        $this->select[] = "$value_column, $text_column";

        $this->_extra($extra);
        $this->_extra_select($extra);
        $this->_extra_where($extra);
        $this->order_by($extra);
        $this->call_before_extra_select($extra);

        $query = $this->db->get("$this->table $this->as");        
        $rows = object_change_key_case($query->result());
                
        //$options = array();
        $options = array($first_value => $first_text);
        foreach($rows as $row)
        {
            $options[$row->{strtolower($value_column)}] = $row->{strtolower($text_column)};
        }

        $query->free_result();
        $this->_reset_variables();

        return $options;
    }

    /**
     * Veritabanına kayıt ekler
     * 
     * @param type $data 
     */
    public function insert($data = array())
    {
        $query = $this->db->insert($this->table, $this->prepare_data($data));

        if($query)
        {
            if($this->auto_increment != '')
            {
                return $this->db->insert_id();
            }
            else
            {
                return TRUE;
            }
        }

        return FALSE;
    }

    /**
     * Veritabanındaki kayıdı id değerine göre düzenler    
     * 
     * @param type $id
     * @param type $data
     * @param type $extra 
     */
    public function update($id, $data = array())
    {
        if(is_array($id))
        {
            $this->db->where_in($this->auto_increment, $this->clean_id($id));
        }
        else
        {
            $this->db->where($this->auto_increment, $this->clean_id($id));
        }

        $this->db->set($this->prepare_data($data))->update($this->table);
        return $this->db->affected_rows();
    }

    /**
     * Veritabanındaki kayıdı where koşulu ekleyerek düzenler
     * 
     * @param type $where
     * @param type $data 
     */
    public function update_where($where = array(), $data = array())
    {
        $this->db->where($where);
        $this->db->set($this->prepare_data($data))->update($this->table);
        return $this->db->affected_rows();
    }

    /**
     * Veritabanındaki id değeri ile eşleşen kaydı siler
     * 
     * @param type $id 
     */
    public function delete($id, $extra = array())
    {
        if(is_array($id))
        {
            $this->db->where_in($this->auto_increment, $this->clean_id($id));
        }
        else
        {
            $this->db->where($this->auto_increment, $this->clean_id($id));
        }

        if(!empty($extra))
        {
            $this->db->where($extra);
        }

        $this->db->delete($this->table);
        return $this->db->affected_rows();
    }

    /**
     * Veritabanındaki kayıdı where koşulu ekleyerek siler
     * 
     * @param type $where 
     */
    public function delete_where($where = array())
    {
        $this->db->where($where)->delete($this->table);
        return $this->db->affected_rows();
    }

    /**
     * Yukarıda select sorguları yapan fonksiyonlar kendilerine gelen $extra parametrelerini bu
     * fonksiyona gönderirler.     
     *  
     * @param type $extra 
     */
    protected function _extra(&$extra = array())
    {
        if(empty($extra)) return;

        if(isset($extra['callback']))
        {
            if(is_array($extra['callback']))
            {
                foreach($extra['callback'] as $key => $e)
                {
                    $callback = 'callback_' . $e;
                    if(method_exists($this, $callback))
                    {
                        $this->$callback($extra);
                    }
                }
            }
            else if(is_string($extra['callback']))
            {
                $callback = 'callback_' . $extra['callback'];
                if(method_exists($this, $callback))
                {
                    $this->$callback($extra);
                }
            }
        }
        unset($extra['callback']);

        #limit
        if(isset($extra['limit']))
        {
            if(isset($extra['offset']))
            {
                $this->limit($this->clean_id($extra['limit']), $this->clean_id($extra['offset']));
                unset($extra['offset']);
            }
            else
            {
                $this->limit($this->clean_id($extra['limit']));
            }
            unset($extra['limit']);
        }
    }

    /**
     * Örneğin select sorgusunda seçilecek alanları belirlemek istersek şöyle bir dizi göndermeliyiz
     * $extra = array('select'=>'column1,column2,column4')
     * 
     * @param type $extra 
     */
    private function _extra_select(&$extra)
    {        
        if(isset($extra['distinct']) && $extra['distinct'] === TRUE)
        {
            $this->db->distinct();
            unset($extra['distinct']);
        }
        
        if(isset($extra['select']))
        {
            if($extra['select']===FALSE)
            {
                return;
            }
            
            $this->select = array();
            $this->select[] = $extra['select'];
            unset($extra['select']);
        }

        if(empty($this->select))
        {
            $this->select[] = $this->as . '.*';
            $this->db->select($this->select);
            return;
        }

        $select_string = implode(',', $this->select);
        $select_array = explode(',', $select_string);

        if(empty($select_array)) return;

        foreach($select_array as $key => $e)
        {
            if(strpos($e, '.') === FALSE && in_array(trim($e), $this->table_columns))
            {
                $select_array[$key] = $this->as . '.' . trim($e);
            }
        }
        unset($e);

        $this->select = $select_array;
        $this->db->select($this->select);

        unset($select_array);
        return $this;
    }

    protected function _extra_where(&$extra = array())
    {
        if(!isset($extra) || empty($extra)) return;
        $this->_set_where_rules();

        foreach($extra as $key => $e)
        {
            $rule = trim($key);
            if(isset($this->where_rules[$rule]))
            {
                $where_rule = $this->where_rules[$rule];
                $column = $where_rule['column'];
                $function = $where_rule['function'];

                if(strpos($column, '.') === FALSE)
                {
                    $column = $this->as . '.' . $column;
                }
                $this->db->{$function}($column, $e);
                unset($extra[$key]);
            }
            elseif(strpos($rule, ' ') !== FALSE)
            {
                $arr = explode(' ', trim($rule));
                $rule = $arr[0];

                if(isset($this->where_rules[$rule]))
                {
                    $where_rule = $this->where_rules[$rule];
                    $column = $where_rule['column'];
                    $function = $where_rule['function'];

                    if(strpos($column, '.') === FALSE)
                    {
                        $column = $this->as . '.' . $column;
                    }
                    $column = $column . ' ' . $arr[1];

                    $this->db->{$function}($column, $e);
                    unset($extra[$key]);
                }
            }
        }
    }

    private function _set_where_rules()
    {
        if(!empty($this->where_rules))
        {
            return;
        }

        $add_last_array = array(
            'where' => '',
            'where_in' => '__in',
            'or_where_in' => '__or_in',
            'where_not_in' => '__not_in',
            'or_where_not_in' => '__or_not_in',
            'or_where' => '__or',
            'like' => '__like',
            'or_like' => '__or_like',
            'not_like' => '__not_like',
            'or_not_like' => '__or_not_like'
        );

        $where_rules = array();
        foreach($this->table_columns as $column)
        {
            foreach($add_last_array as $function => $add_last)
            {
                $where_rules[$column . $add_last] = array('function' => $function, 'column' => $column);
            }
        }
        unset($column);

        $this->where_rules = $where_rules;
    }

    public function limit($limit, $offset = 0)
    {
        $this->db->limit($this->clean_id($limit), $this->clean_id($offset));
        return $this;
    }

    
    /**
     * $order_by = array('order'=>'DESC','order_by'=>array('alan1 ASC','alan2') )
     * 
     * @param type $order_by
     * @param type $order
     * @return \MY_Model 
     */
    public function order_by($order_by = '', $order = 'ASC')
    {
        if(is_array($order_by))
        {
            $_order_by = isset($order_by['order_by']) ? $order_by['order_by'] : '';
            $_order = isset($order_by['order']) ? $order_by['order'] : '';
        }

        if(empty($_order_by))
        {
            if($this->auto_increment)
            {
                $this->db->order_by($this->as . '.' . $this->auto_increment, 'DESC');
            }
            return $this;
        }

        if(!is_array($_order_by))
        {
            $_order_by = array($_order_by);
        }

        foreach($_order_by as $e)
        {
            $order_by = $e;
            $order = $_order;
            if(strpos($e,' ') !== FALSE)
            {
                $array = explode(' ', $e);
                $order_by = $array[0];
                $order = $array[1];
            }

            if(strpos($order_by,'.') === FALSE)
            {
                $order_by = $this->as . '.' . $order_by;
            }

            $order = (in_array(strtoupper($order), array('ASC', 'DESC'))) ? $order : 'DESC';
            $this->db->order_by($order_by, $order);
        }

        return $this;
    }

    public function set_extra_from_url(&$extra, $uri_assoc = array())
    {
        static $uri_params;

        $_extra = array(
            'limit' => 10,
            'offset' => 0,
            'callback' => array()
        );
        $extra = array_merge($_extra, $extra);
        if(empty($uri_params))
        {
            $CI = &get_instance();
            $post = $CI->input->post(NULL, TRUE);
            $get = $CI->input->get(NULL, TRUE);
            $uri_params = array_merge(($post) ? $post : array(), ($get) ? $get : array());
            $uri_params = array_merge($uri_params, $uri_assoc);
        }
        if(empty($uri_params))
        {
            return;
        }

        $default_uri_params = array('search', 'q', 'sort', 'dir', 'page', 'rand');

        if(isset($uri_params['sort']))
        {
            $extra['order_by'] = $uri_params['sort'];
        }
        if(isset($uri_params['dir']))
        {
            $extra['order'] = $uri_params['dir'];
        }
        if(isset($uri_params['page']))
        {
            $sayfa = (isset($uri_params['page'])) ? (int) $uri_params['page'] : 0;
            $sayfa = ($sayfa > 0) ? --$sayfa : 0;
            $extra['offset'] = ($sayfa * $extra['limit']);
        }

        if(isset($uri_params['q']))
        {
            $extra['q'] = $uri_params['q'];
            $extra['callback'][] = 'search';
        }
        $is_search = (isset($uri_params['search']) && $uri_params['search'] == 'true') ? TRUE : FALSE;

        foreach($uri_params as $key => $value)
        {
            if(in_array($key, $this->table_columns))
            {
                if($is_search === TRUE)
                {
                    if(!empty($value) > 0)
                    {
                        $extra["{$key}__like"] = $value;
                    }
                }
                else
                {
                    $extra["$key"] = $value;
                }
            }
        }

        //join callbackleri ayarla
        $uri_params_keys = array_keys($uri_params);
        $db_join_params = array_diff($uri_params_keys, array_merge($this->table_columns, $default_uri_params));
        foreach($db_join_params as $e)
        {
            $extra['callback'][] = $e;
        }
    }

    public function set_table($table = '')
    {
        $this->table = $table;
    }

    public function set_auto_increment($auto_increment = '')
    {
        $this->auto_increment = $auto_increment;
    }

    protected function set_table_columns()
    {
        $this->table_columns = $this->config->item($this->table, 'db_tables');
        if(empty($this->table_columns))
        {
            $this->table_columns = $this->config->item(strtolower($this->table), 'db_tables');
        }
    }

    /**
     * İnsert ve Update işlemlerinde verileri hazılar
     * 
     * @param type $data 
     */
    protected function prepare_data($data = array())
    {
        if(empty($data))
        {
            return $data;
        }

        foreach($data as $key => $e)
        {
            $e = trim($e);

            if(is_null($e))
            {
                $data[$key] = NULL;
            }
            else
            {
                $data[$key] = $e;
            }
        }

        return $data;
    }

    /**
     * id değerini inte cast eder
     * @param type $id 
     */
    protected function clean_id($id)
    {
        if(!is_array($id))
        {
            $id = intval($id);
        }
        else
        {
            foreach($id as $key => $e)
            {
                $id[$key] = intval($e);
            }
        }

        return $id;
    }

}