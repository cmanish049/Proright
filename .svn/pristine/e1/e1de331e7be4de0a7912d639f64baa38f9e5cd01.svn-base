<?php
define('ADMIN_CONTROLLER_DIRECTORY', 'admin');

/**
 * Description of class_generator
 *
 * @author Alexander
 */
class class_generator extends Admin_Controller
{
    public $table_name;
    private $table_fields = array();
    private $search_fields = array();
    private $auto_increment;
    public $single_name;
    public $controller_name;
    public $controller_class_name;
    public $model_name;
    public $model_class_name;
    private $db_string_types = array('varchar', 'text', 'longtext', 'char');
    private $db_int_types = array('int', 'tinyint', 'bigint', 'float', 'double', 'decimal', 'numeric');
    private $db_textarea_types = array('text', 'longtext');
    public $messages = array();

    public function __construct()
    {
        parent::__construct();
        error_reporting(E_ALL);
        $this->load->helper('file');
        
        
    }

    public function index()
    {
        $this->data['h2'] = 'Class Oluşturucu';
        $this->data['form_action'] = admin_url('class_generator/index');
        
        /*
        $sql = "SHOW COLUMNS FROM countries";
        $query = $this->db->query($sql);
        $row = $query->row();pre($row);
        echo $row->field;*/
        
        if($_POST)
        {
            $this->table_name = trim(strtolower($this->input->post('table_name')));
            $this->single_name = trim(strtolower($this->input->post('single_name')));
            $this->search_fields = explode(',', trim($this->input->post('search_fields')));

            $this->controller_name = $this->single_name;
            $this->controller_class_name = ucfirst($this->controller_name);

            $this->model_name = "{$this->controller_name}_model";
            $this->model_class_name = ucfirst($this->model_name);

            if($this->db->table_exists($this->table_name))
            {
                $sql = "SHOW COLUMNS FROM $this->table_name";
                $query = $this->db->query($sql);
                $row = $query->row();
                
                $this->table_fields = $this->db->field_data($this->table_name);
                
                /**
                 * set fields is null 
                 */
                $sql = "SHOW COLUMNS FROM $this->table_name ";
                $query = $this->db->query($sql);
                $fields = $query->result();
                foreach($this->table_fields as $key => $e)
                {
                    foreach($fields as $f)
                    {
                        if($f->Field==$e->name)
                        {
                            $e->null = $f->Null;
                            $this->table_fields[$key] = $e;
                        }
                    }
                }
                
                $this->set_auto_increment();

                if(is_input_checked('controller'))
                {
                    $this->generate_controller();
                }

                if(is_input_checked('model'))
                {
                    $this->generate_model();
                }

                if(is_input_checked('views'))
                {
                    $this->generate_views();
                }
            }
            else
            {
                $this->messages[] = 'Tablo veritabanında bulunamadı.';
            }
        }

        $this->data['messages'] = $this->messages;

        $this->template->view_parts('content', 'class_generator/index_view', $this->data)
                ->title('Class oluşturucu')
                ->build();
    }

    public function set_auto_increment()
    {
        foreach($this->table_fields as $key => $e)
        {
            if($e->primary_key)
            {
                $this->auto_increment = $e->name;
                break;
            }
        }
    }

    public function generate_controller()
    {
        $path_controller = APPPATH . "controllers/" . ADMIN_CONTROLLER_DIRECTORY . "/{$this->controller_name}.php";
        $template_controller = read_file('class_templates/controller_template.php');

        $template_db_data = "'{field_name}' => " . '$this->input' . "->post('{field_input_name}', TRUE),";
        $template_validation_rule = "array(
            'field' => '{field_name}',
            'label' => '{field_label}',
            'rules' => 'trim|max_length[{size}]|numeric|required'
        ),";

        $db_string_types = $this->db_string_types;
        $db_int_types = $this->db_int_types;

        $str_validation_rules = '';
        $str_db_data = '';
        $str_col_sort_params = "'',";
        $str_col_widths = "'100px',";
        $col_width_percent = ceil(90 / (count($this->table_fields) - 1));
        foreach($this->table_fields as $key => $e)
        {
            $field_name = $e->name;
            $type = $e->type;
            $max_length = $e->max_length;
            $is_primary_key = $e->primary_key;

            if($is_primary_key)
            {
                continue;
            }

            $str_col_sort_params .= "'$field_name',";
            $str_col_widths .= "'$col_width_percent%',";

            //db_table dizisi string
            $search = array('{field_name}','{field_input_name}');
            $replace = array($field_name,strtolower($field_name));
            $str_db_data .= str_replace($search, $replace, $template_db_data) . "\n";

            //validasyon kuralları string
            $search = array('{field_name}', '|max_length[{size}]', '|numeric', '|required', '{field_label}');
            $replace = array(
                strtolower($field_name),
                (in_array($type, $db_string_types) && $max_length > 0) ? "|max_length[{$max_length}]" : '',
                (in_array($type, $db_int_types)) ? '|numeric' : '',
                $e->null=='NO' ? '|required' : '',
                str_replace('_', ' ', humanize($field_name)),
            );
            $str_validation_rules .= str_replace($search, $replace, $template_validation_rule) . "\n";
        }
        $str_col_sort_params = substr_replace($str_col_sort_params, '', -1);
        $str_col_widths = substr_replace($str_col_widths, '', -1);

        //controller dosyasını oluştur
        $search = array('{class_name}', '{controller_name}', '{modul_name}', '{model_name}',
            '{single_name}', '{db_data}', '{validation_rules}', '{col_sort_params}', '{col_widths}');
        $replace = array(
            $this->controller_class_name,
            $this->controller_name,
            $this->single_name,
            $this->model_name,
            $this->single_name,
            $str_db_data,
            $str_validation_rules,
            $str_col_sort_params,
            $str_col_widths
        );
        $str = str_replace($search, $replace, $template_controller);
        if(file_exists($path_controller))
        {
            $this->messages[] = $path_controller . ' dosyası zaten oluşturulmuş<br/>';
        }
        elseif(write_file($path_controller, $str))
        {
            $this->messages[] = "$path_controller => Başarılı";
        }
    }

    public function generate_model()
    {
        $path_model = APPPATH . "models/{$this->model_name}.php";
        $template_model = read_file('class_templates/model_template.php');

        #model dosyasını oluştur
        $search = array('{model_class_name}', '{table_name}', '{primary_key}', '{search_fields}');
        $replace = array(
            $this->model_class_name,
            $this->table_name,
            $this->auto_increment,
            implode(',', $this->search_fields)
        );
        $str = str_replace($search, $replace, $template_model);
        if(file_exists($path_model))
        {
            $this->messages[] = $path_model . ' dosyası zaten oluşturulmuş<br/>';
        }
        elseif(write_file($path_model, $str))
        {
            $this->messages[] = "$path_model => Başarılı";
        }
    }

    public function generate_views()
    {
        $path_view_index = APPPATH . "views/admin-bootstrap/{$this->controller_name}/index_view.php";
        $path_view_grid = APPPATH . "views/admin-bootstrap/{$this->controller_name}/grid_view.php";
        $path_view_form = APPPATH . "views/admin-bootstrap/{$this->controller_name}/form_view.php";

        $template_view_form = read_file('class_templates/views/form_view.php');
        $template_view_grid = read_file('class_templates/views/grid_view.php');
        $template_view_index = read_file('class_templates/views/index_view.php');

        $template_input_controls = '            
                <div class="control-group">
                    <label class="control-label form-lbl" for="{field_name}"><?php _e(\'{field_label}\') ?></label>
                    <div class="controls">
                        <?php echo form_input(\'{field_name}\',  set_value(\'{field_name}\', object_element(\'{field_name}\', $row)), \'class="validate[integer,maxSize[{size}],required] input-xlarge" id="{field_name}" tabindex="{tabindex}" \'); ?>
                    </div>
                </div>                
        ';

        $template_input_textarea = '
            <div class="control-group">
                <label class="control-label form-lbl" for="{field_name}"><?php _e(\'{field_label}\') ?></label> 
                <div class="controls">
                    <?php echo form_textarea(array(\'name\' => \'{field_name}\', \'rows\' => 5, \'cols\' => 40), 
                        set_value(\'{field_name}\', (object_element(\'{field_name}\', $row))), 
                        \'class="validate[maxSize[{size}],required] input-xlarge js-editor" id="{field_name}" tabindex="{tabindex}"\'); ?>
                </div>                
            </div>';

        $template_input_dropdown = '
            <div class="control-group">
                <label class="control-label form-lbl" for="{field_name}"><?php _e(\'{field_label}\') ?></label>
                <div class="controls">
                    <?php
                        {dropdown_options}
                        echo form_dropdown(\'{field_name}\', $dropdown_{field_name}, set_value(\'{field_name}\', object_element(\'{field_name}\', $row)), 
                                \'class="validate[integer,maxSize[{size}],required] input-xlarge" id="{field_name}" tabindex="{tabindex}"\' );
                    ?>
                </div>
            </div> ';

        $enum_dropdown_options = "array(
            'yes' => __('Yes'),
            'no' => __('No')
        )";
        
        $str_input_controls = '';
        $str_index_columns = '';
        $str_grid_columns = '';
        $str_dropdown_options = '';
        
        $table_fields = array();
        foreach($this->table_fields as $e)
        {
            $e->name = strtolower($e->name);
            $table_fields[] = $e;
        }
        foreach($table_fields as $key => $e)
        {
            $field_name = $e->name;
            $type = $e->type;
            $max_length = $e->max_length;
            $is_primary_key = $e->primary_key;
            $default = $e->default;

            if($is_primary_key)
            {
                continue;
            }

            $str_index_columns .= "<th><?php _e('" . str_replace('_', ' ', humanize($field_name)) . "'); ?></th>\n";

            $grid_td_style = ' style=""';
            $grid_td_in = '<?php echo $e->' . $field_name . '; ?>';
            if($type == 'enum')
            {
                $grid_td_style = ' style="text-align:center;"';
                $grid_td_in = '<?php echo grid_column_label($e->' . $field_name . '); ?>';
            }
            else if(in_array($type, $this->db_int_types))
            {
                $grid_td_style = ' style="text-align:right;"';
            }
            $str_grid_columns .= '<td' . $grid_td_style . '>' . $grid_td_in . '</td>' . "\n";

            if($type == 'enum')
            {
                $_dropdown_options = $enum_dropdown_options;
                $str_dropdown_options = '$dropdown_' . "$field_name = $_dropdown_options;";
            }

            $search = array('{field_name}', 'maxSize[{size}]', 'integer,', ',required', '{field_label}', '{dropdown_options}','{tabindex}');
            $replace = array(
                $field_name,
                (in_array($type, $this->db_string_types) && $max_length > 0) ? "maxSize[{$max_length}]" : '',
                (in_array($type, $this->db_int_types)) ? 'integer' : '',
                $e->null=='NO' ? ',required' : '',
                str_replace('_', ' ', humanize($field_name)),
                $str_dropdown_options,
                $key+1
            );
            $str_dropdown_options = '';
                
            if(in_array($type, $this->db_textarea_types))
            {
                $str_input_controls .= str_replace($search, $replace, $template_input_textarea);
            }
            elseif(strpos($field_name, '_id') !== FALSE || $type == 'enum')
            {
                $str_input_controls .= str_replace($search, $replace, $template_input_dropdown);
            }
            else
            {
                $str_input_controls .= str_replace($search, $replace, $template_input_controls);
            }
        }

        $view_directory = "views/admin-bootstrap/$this->controller_name";
        if(!is_dir(APPPATH . $view_directory))
        {
            mkdir(APPPATH . $view_directory);
        }

        #index_view dosyasını oluştur
        $search = array('{single_name}', '{controller_name}', '{primary_key}',
            '{controls}', '{index_columns}', '{grid_columns}');
        $replace = array(
            $this->single_name,
            $this->controller_name,
            strtolower($this->auto_increment),
            $str_input_controls,
            $str_index_columns,
            $str_grid_columns
        );
        $str = str_replace($search, $replace, $template_view_index);
        if(file_exists($path_view_index))
        {
            $this->messages[] = $path_view_index . ' dosyası zaten oluşturulmuş<br/>';
        }
        elseif(write_file($path_view_index, $str))
        {
            $this->messages[] = "$path_view_index => Başarılı";
        }

        #grid_view
        $str = str_replace($search, $replace, $template_view_grid);
        if(file_exists($path_view_grid))
        {
            $this->messages[] = $path_view_grid . ' dosyası zaten oluşturulmuş<br/>';
        }
        elseif(write_file($path_view_grid, $str))
        {
            $this->messages[] = "$path_view_grid => Başarılı";
        }

        $str = str_replace($search, $replace, $template_view_form);
        if(file_exists($path_view_form))
        {
            $this->messages[] = $path_view_form . ' dosyası zaten oluşturulmuş<br/>';
        }
        elseif(write_file($path_view_form, $str))
        {
            $this->messages[] = "$path_view_form => Başarılı";
        }
    }

}
