<?php

/**
 * Description of ajax
 *
 * @author Alexander
 */
class Ajax extends Admin_Controller
{

    public function __construct()
    {
        parent::__construct();

        $this->config->set_item('compress_output', FALSE);
    }

    public function autocomplete_kullanicilar()
    {
        $this->load->model('kullanici_model');
        $get = $this->input->get(NULL, TRUE);

        $ekstra = array(
            'select' => "kullanici_adi, kullanici_id",
            'kullanici_durumu' => 'aktif',
            'kelime' => (isset($get['q'])) ? $get['q'] : $get['term'],
            'limit' => 10,
            'order_by' => 'adi',
            'order' => 'ASC',
            'kullanici_tipi' => element('kullanici_tipi', $this->uri_assoc),
            'callback' => array('ara')
        );
        $ekstra['kelime'] = urldecode($ekstra['kelime']);
        $kullanicilar = $this->kullanici_model->get_rows($ekstra);

        $array = array();
        foreach($kullanicilar as $k)
        {
            $array[] = array('kullanici_id' => $k->kullanici_id, 'kullanici_adi' => $k->adsoyad);
        }

        $this->output->_display($this->_get_json_for_autocomplete($array, 'kullanici_id', 'kullanici_adi'));
    }

    public function autocomplete_yazilar()
    {
        $this->load->model('yazi_model');
        $get = $this->input->get(NULL, TRUE);

        $ekstra = array(
            'yazi_tipi' => element('yazi_tipi', $this->uri_assoc),
            'yazi_durumu !=' => 'silindi',
            'callback' => array('join_kullanici', 'ara'),
            'kelime' => (isset($get['q'])) ? $get['q'] : $get['term'],
            'limit' => 10,
            'order_by' => 'baslik',
            'order' => 'ASC',
        );
        $ekstra['kelime'] = urldecode($ekstra['kelime']);
        $this->yazi_model->set_ekstra_from_url($ekstra);
        $yazilar = $this->yazi_model->get_rows($ekstra);

        $array = array();
        foreach($yazilar as $e)
        {
            $array[] = array('yazi_id' => $e->yazi_id, 'baslik' => "$e->baslik ($e->adsoyad)");
        }

        $this->output->_display($this->_get_json_for_autocomplete($array, 'yazi_id', 'baslik'));
    }

    private function _get_json_for_autocomplete($array = array(), $value_field = '', $text_field = '')
    {
        $json = array();
        foreach($array as $index => $a)
        {
            if(is_object($a))
            {
                $json[] = array('id' => $a->{$value_field}, 'value' => $a->{$text_field}, 'label' => $a->{$text_field});
            }
            else
            {
                $json[] = array('id' => $a[$value_field], 'value' => $a[$text_field], 'label' => $a[$text_field]);
            }
        }

        return $this->fastjson->encode($json);
    }

    function bind_select_sehirler()
    {
        $this->load->model('sehir_model');
        $json = $this->sehir_model->get_rows(
                array(
                    'ulke_id' => $this->input->get('value'),
                    'select' => 'sehir_id AS value, sehir_adi AS text',
                    'order_by' => 'sehir_adi',
                    'order' => 'ASC'
                )
        );
        array_unshift($json, array('value' => '0', 'text' => 'Seçiniz'));

        $this->output->_display($this->fastjson->encode($json));
    }

    function bind_select_okullar()
    {
        $this->load->model('okul_model');
        $json = $this->okul_model->get_rows(
                array(
                    'sehir_id' => $this->input->get('value'),
                    'select' => 'okul_id AS value, okul_adi AS text',
                    'order_by' => 'okul_adi',
                    'order' => 'ASC'
                )
        );
        array_unshift($json, array('value' => '0', 'text' => 'Seçiniz'));
        $this->output->_display($this->fastjson->encode($json));
    }

}

